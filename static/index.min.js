(async()=>{let{protocol:e,host:s}=location,{v:i,f:a}=Object.fromEntries(new URLSearchParams(location.search));function r(s,i,a=!1){var t=(t,e)=>a?i(t[s])-i(e[s]):i(e[s])-i(t[s]),{sort:e,slice:r,toSorted:n}=Array.prototype;return n?.call(this,t)||e.call(r.call(this),t)}let n=await fetch("/constant").then(t=>t.json()),o=new Vue({el:"#box",data:{originDomain:n.domain.originDomain,thirdDomain:n.domain.thirdDomain,instruction:null,overlay:{pics:!1,error:!1,serial:!0,history:!1,magnet:!1,reflow:!1,isfloat:!1,proxies:!1,sidenav:!1,dashboard:!1},fragment:{size:n.dataOptionsNomarl.fragment.size,idx:n.dataOptionsNomarl.fragment.idx},chat:{overlay:{textSwitch:!1},textMessage:"",group:[],state:n.dataOptionsNomarl.chat.state,enable:!1,session:"",socket:null,mediaRecorder:null,voiceChunks:[]},main:{page:0,log:n.dataOptionsNomarl.main.log,error:"",select:n.dataOptionsNomarl.main.select,mode:n.dataOptionsNomarl.main.mode,state:n.dataOptionsNomarl.main.state,serial:"",keyWord:"",socket:null,heartbeat:0,slideSpeed:n.dataOptionsNomarl.main.slideSpeed,needReconnect:!0,reconnectTimeout:n.dataOptionsNomarl.main.reconnectTimeout},manual:{bookmark:!1,origin:!0},status:{isdone:!0,vthumb:!0,autoview:!1,single:!1,stars:!1,genre:!1,studio:!1,label:!1,director:!1,onsunc:!1},preview:{pics:[],picsIndex:-1,picsEl:null,picsSwipe:!1},magnet:[],reflow:[],bookmark:[],taglist:{},dynamiclist:[],history:[],sconf:null,observer:null,offset:null,throttled:{nav:null,load:null,slide:null,scroll:null,update:null,heartbeat:null,prefixscroll:null},pressTimer:null,proxies:[],theme:"normal",description:"standard"},methods:{async selectProxy(t){if(this.status.isdone)return this.status.isdone=!1,this.overlay.reflow=!1,this.overlay.proxies=!1,this.main.log=await fetch(""+n.resourceRouter.toggleProxy+(t+n.constantNumber.passProxy)).then(t=>t.text()),this.proxies=this.snippetArray((await fetch(n.resourceRouter.proxies).then(t=>t.json())).slice(n.constantNumber.passProxy),n.snippet.proxy),this.status.isdone=!this.status.isdone,null;alert(n.constantString.alertString.selectProxy)},async updateProxy(){this.overlay.reflow=!1,this.main.log=await fetch(n.resourceRouter.updateProxy).then(t=>t.text())},flushHistory(){return this.overlay.history=this.history.length,this.history=Object.keys(localStorage).filter(t=>t!=n.constantString.flagString._data),null},loadHistory(t){t=JSON.parse(localStorage.getItem(t));return this.jumpLocation(t.sconf.keyWord,t.description),null},autoScroll({touches:[t]}){this.throttled.prefix=setTimeout(()=>{this.offset=Math.floor(this.$refs.box.scrollTop);let e=t.clientX>=window.innerHeight>>2,s=(cancelAnimationFrame(this.throttled.slide),()=>{var t=this.offset+=e?this.main.slideSpeed:-this.main.slideSpeed;this.scrollToTop(t,n.constantString.flagString.autoScrollBehavior),this.throttled.slide=requestAnimationFrame(s)});s()},n.timer.invokeSlideTimeout)},stopScroll(){clearTimeout(this.throttled.prefix),cancelAnimationFrame(this.throttled.slide)},import_(){var t;if(console.log(this.main.serial),/^[a-zA-Z]+-\d+(\s*,\s*[a-zA-Z]+-\d+)*$/.test(this.main.serial))return this.dynamiclist=[],this.overlay.reflow=!1,this.overlay.serial=!1,(t=this.main.serial.split(",")).forEach(t=>{this.main.socket.send(JSON.stringify({type:"search",keyWord:t,range:[1]}))}),this.main.log=n.constantString.flagString.import+":"+t.length,null;alert(n.constantString.alertString.import_)},export_(){var t=this.filterRule.map(({m:t})=>t.find(({href:t,text:[e]})=>/uncen/gi.test(e)?t:null)).map(t=>t.href).join(";");return navigator.clipboard.writeText(t),this.main.log=n.constantString.alertString.export_,null},toggleItem(s){return this.instruction[s].expand=!this.instruction[s].expand,this.instruction.forEach((t,e)=>{e!=s&&(t.expand=!1)}),null},recordStart(t){return this.chat.voiceChunks=[],t.target.classList.toggle("bgc"),this.chat.mediaRecorder.start(),this.pressTimer=setTimeout(()=>{this.chat.mediaRecorder.stop()},6e4),null},recordStop(t){return this.chat.mediaRecorder.stop(),t.target.classList.toggle("bgc"),clearTimeout(this.pressTimer)},search(){if(!this.status.isdone)return alert(n.constantString.alertString.search);if(3==!this.main.socket.readyState)return this.main.log=n.constantString.flagString.socketDisconnect;this.reflow=[],this.dynamiclist=[],this.status.isdone=!1,this.overlay.proxies=!1,this.description=(this.status.stars?"star":this.status.genre&&"genre")||(this.status.studio?"studio":this.status.label&&"label")||(this.status.director?"director":"standard");var s={type:"search",stars:this.status.stars,genre:this.status.genre,onsunc:this.status.onsunc,director:this.status.director,studio:this.status.studio,label:this.status.label};if(this.main.keyWord.includes(n.constantString.flagString.searchSplit)){let[t,e]=this.main.keyWord.split(n.constantString.flagString.searchSplit);e=e.split(n.constantString.flagString.searchPageSplit),this.main.page=1<e.length?e[1]:e[0],this.sconf={...s,keyWord:t,range:e}}else this.main.page=1,this.sconf={...s,keyWord:this.main.keyWord,range:[this.main.page]};return this.main.socket.send(JSON.stringify(this.sconf)),null},async sleep(e){return new Promise(t=>{setTimeout(()=>{t(null)},e)})},async loadView(t){this.main.log=t.n,this.status.isdone=!1;var e=await fetch(""+n.resourceRouter.views+t.n).then(t=>t.text());return this.main.log=""+t.n+n.constantString.flagString.logFormat+e,o.$set(t,"v",parseInt(e)),this.main.log=n.constantString.flagString.done,this.status.isdone=!0,null},async loadViews(){if(this.dynamiclist.length){let s=[];this.main.log=this.filterRule.length,this.status.isdone=!1;var e=this.snippetArray(this.filterRule,n.snippet.views);for(let t=0;t<=e.length-1;t++)await this.sleep(n.timer.viewsLoadDealy),e[t].forEach(async(e,t)=>{s.push((async()=>{var t;if(!e?.v||-1==e.v)return t=await fetch(""+n.resourceRouter.views+e.n).then(t=>t.text()),this.main.log=""+e.n+n.constantString.flagString.logFormat+t,o.$set(e,"v",parseInt(t)),{n:e.n,view:t}})())});Promise.allSettled(s).then(t=>{console.log(t),this.main.log=n.constantString.flagString.done,this.status.isdone=!0})}return null},reflowBack(t,e){return this.status.isdone=!1,this.main.socket.send(JSON.stringify({type:"search",keyWord:t,range:[1]})),null},reflowList(){return this.reflow.forEach(({value:{n:t}})=>{this.main.socket.send(JSON.stringify({type:"search",keyWord:t,range:[1]}))}),null},clearList(){return this.reflow=[]},onlyPush(t,e,s){return this.dynamiclist.push({n:t,...e,r:!1}),this.reflow.splice(s,1),null},stop(){return this.main.socket.send(JSON.stringify({type:"abort"})),null},reset(){return this.main.socket.close(),location.href=location.origin,localStorage.clear(),null},home(){return location.href=location.origin,null},save(){var t=document.documentElement.outerHTML,t=URL.createObjectURL(new Blob([t],{type:"text/html"})),e=document.createElement("a");return e.href=t,e.download=this.main.keyWord,document.body.appendChild(e),e.click(),document.body.removeChild(e),null},jumpLocation(t,e){return location.href=location.origin+`?v=${t}&f=`+(e.includes("star")?e+"s":e)},jumpTag(e){this.pressTimer=setTimeout(()=>{var t=new URL(e).pathname.split("/");this.jumpLocation(t[2],t[1])},n.timer.jumpTagTimeout)},cancelJump(){return clearTimeout(this.pressTimer)},loadMorePage({target:i}){return clearTimeout(this.throttled.scroll),this.throttled.scroll=setTimeout(()=>{var{clientHeight:t,scrollHeight:e,scrollTop:s}=i,e=e-Math.ceil(s);this.offset=Math.floor(s),t-2<=e&&e<=t+2&&!this.throttled.load&&this.status.isdone&&this.dynamiclist.length&&(this.main.page++,this.main.socket.send(JSON.stringify({...this.sconf,range:[this.main.page]})),this.status.isdone=!1,this.throttled.load=setTimeout(()=>{this.throttled.load=null},n.timer.morePageInterval))},n.timer.scrollThrottled),null},snippetArray(t,e){let s,i;s=i=0;for(var a=[];i<=t.length;)[i,s]=[s+e,i],s!=i&&a.push(t.slice(s,i));return a},zoomPics({i:t}){return this.preview.pics=t||[],this.overlay.pics=t?.length&&!0,null},openSwipe(t,{target:e}){this.preview.picsIndex=t,this.preview.picsEl=e,this.preview.picsEl.classList.add(n.constantString.classString.swipe),setTimeout(()=>{this.preview.picsSwipe=!this.preview.picsSwipe},300)},closeSwipe(){return this.preview.picsIndex=-1,this.preview.picsSwipe=!this.preview.picsSwipe,setTimeout(()=>{this.preview.picsEl.classList.remove(n.constantString.classString.swipe)},100),null},expandMagnet(t){return this.magnet=t,this.overlay.magnet=t?.length&&!0,null},async updateBookmark(t,e,s){var{children:[{children:[i]}]}=t["target"],a=n.bookmark[s];switch(s){case"insert":i.style.fill=a.color,this.main.socket.send(JSON.stringify({type:"INSERT",data:e})),e.inserted=!0;break;case"remove":i.style.fill=a.color,this.main.socket.send(JSON.stringify({type:"REMOVE",data:e.n}))}return await this.sleep(a.delay),i.style.display="none",this.flushBookMark(),null},async flushBookMark(){return this.status.isdone=!1,this.bookmark=await fetch(n.resourceRouter.bookmark).then(t=>t.json()),null},visibNav(){return this.overlay.sidenav=!0,clearTimeout(this.throttled.nav),this.throttled.nav=setTimeout(()=>{this.overlay.sidenav=!1},n.timer.visibilityNavBar),null},connect(){return console.log("connect"),new Promise(t=>{this.main.socket=new WebSocket(`${e.includes("https:")?"wss":"ws"}://`+s+n.websocket.main),this.main.socket.onopen=()=>{t(null),console.log("WebSocket OPEN"),this.main.socket.addEventListener("message",async({data:t})=>{let s=JSON.parse(t);switch(s.type){case"ping":var e=Date.now()-parseInt(s.data);this.main.socket.send(JSON.stringify({type:"pong",data:e})),this.main.heartbeat=e,clearInterval(this.throttled.heartbeat),this.throttled.heartbeat=setInterval(()=>{this.main.socket.close()},n.timer.heartbeatThrottled);break;case"LOG":this.main.log=s.data.n+"<==>"+s.data.c;break;case"DONE":this.main.log=s.data.m,this.reflow=function(t,e){const s=new Set;return t.filter(({value:t})=>{t=t[e];return s.has(t)?null:s.add(t)})}([...this.reflow,...s.data.reflow],"n"),this.status.isdone=!0,this.sconf?.keyWord&&(localStorage.setItem(""+this.sconf?.keyWord+n.constantString.flagString._data,JSON.stringify({...o._data,taglist:null,instruction:null,constant:null})),this.flushHistory());break;case"ERROR":this.main.log=s.data.err;break;case"START":this.main.log=s.data.m;break;case"CENSORED":this.dynamiclist.push({...s.data,i:s.data.i.map(t=>({pt:t,loaded:!1})),gs:!1,vs:!1,inserted:!1}),this.reflow.find(({value:{n:t}},e)=>s.data.n==t?this.reflow.splice(e,1):null)}})},this.main.socket.onclose=()=>{console.log("WebSocket CLOSE"),clearInterval(this.main.heartbeat),this.main.needReconnect&&setTimeout(this.connect,this.main.reconnectTimeout)},this.main.socket.onerror=t=>{console.log("WebSocket ERROR"),this.main.socket.close()}})},scrollToTop(t,e){return this.$refs.box.scrollTo({top:t||0,behavior:e}),null},loadNext(){return this.status.isdone&&this.sconf?(this.main.page++,this.main.socket.send(JSON.stringify({...this.sconf,range:[this.main.page]})),this.status.isdone=!1):alert(n.constantString.alertString.loadNext),null},filterCallback(){var t=[];return"NONE"==this.main.select&&this.main.factor&&t.push("(i.n?.toLocaleLowerCase()?.includes(this.main.factor))"),"TIME"==this.main.select&&4==this.main.factor?.length&&t.push("(i.d?.slice(0, 4) <= this.main.factor)"),this.status.single&&t.push("(i.s?.length || -1) <= 1"),"censored"==this.main.mode&&t.push("i"),"uncensored"==this.main.mode&&t.push("i.r"),t.join(" && ")},connectDetect(){return setInterval(()=>{switch(this.main.socket.readyState){case this.main.socket.CONNECTING:this.main.state=n.websocket.connectState.connecting;break;case this.main.socket.OPEN:this.main.state=n.websocket.connectState.open;break;case this.main.socket.CLOSING:this.main.state=n.websocket.connectState.closing;break;case this.main.socket.CLOSED:this.main.state=n.websocket.connectState.closed}},n.timer.connectDetect),null},getTimeRange(){var t=(new Date).getHours();return(n.themes.day.range[0]<=t&&t<=n.themes.day.range[1]?n.themes.day:n.themes.night.range[0]<=t&&t<=n.themes.night.range[1]?n.themes.night:n.themes.normal).name},flexible(){var t=document.documentElement.getBoundingClientRect()["width"];return document.documentElement.style.fontSize=t<=360?n.flexibleSize.small:n.flexibleSize.big,null},cssTemplate(a){return Object.keys(a).map(t=>{var e,s,i=[];for([e,s]of Object.entries(a[t]))i.push(`${e}:${s};`);return`${t}{${i.join("")}}`}).join("")},thumbSucess({target:t}){return this.$nextTick(()=>{t.classList.add("class","loaded")}),null},initVueOption(t,e,s={}){var i={...e,...s};for(const a in i)t[a]=i[a];return null},inintObserver(){this.observer=new IntersectionObserver((t,s)=>{t.forEach(async({target:t,isIntersecting:e})=>{e&&(t.src!=t.dataset.src&&t.setAttribute("src",t.dataset.src),this.status.autoview&&!this.filterRule[t.dataset.i].v&&(this.main.log=t.dataset.n,e=await fetch(""+n.resourceRouter.views+t.dataset.n).then(t=>t.text()),o.$set(this.filterRule[t.dataset.i],"v",parseInt(e))),s.unobserve(t))})},{rootMargin:"0px 0px 0px 0px",threshold:.5})},chatConnect(){return new Promise(t=>{this.chat.socket=new WebSocket(`${e.includes("https:")?"wss":"ws"}://`+s+n.websocket.chat),this.chat.socket.onopen=()=>{t(null),console.log("WebSocket OPEN"),this.chat.socket.addEventListener("message",async({data:t})=>{var e;if(console.log(t),t instanceof Blob)return e=new Blob([t],{type:"audio/wav"}),e=URL.createObjectURL(e),(e=new Audio(e)).setAttribute("controls",1),e.setAttribute("autoplay",1),document.body.appendChild(e),null;var s=JSON.parse(t);switch(s.type){case"AUTH":this.chat.session=s.UUID;break;case"ONLINE":this.chat.group=s.group}})},this.chat.socket.onclose=()=>{console.log("WebSocket CLOSE")},this.chat.socket.onerror=t=>{console.log("WebSocket ERROR"),this.chat.socket.close()}})}},filters:{actorTotal(t){return(t=t?.length)||-1},extract(t,e){return t=(t&&t.match(/\/(\w+)$/)[1])??t,e?e[t]:t},getProgress(t){return t?.filter(({loaded:t})=>1==t)?.length||0},purgeSuffix(t){return t?.replace(n.constantString.flagString._data,"")}},directives:{lazyLoadOberver:{bind:(t,e,s)=>{},inserted:(e,s,i)=>{console.log(e.dataset.i),console.log(t++)}}},watch:{filterRule:{async handler(){await this.$nextTick(()=>{this.$refs.monitor?.forEach(this.observer.observe.bind(this.observer))})},deep:!1},"main.factor":{handler(t){return this.main.factor=4<=t?.length?this.main.factor.slice(0,4):t},deep:!1},"main.select":{handler(t){this.main.factor=""}},"status.stars":{handler(t){t&&(this.status.genre=!t)}},"status.genre":{handler(t){t&&(this.status.stars=!t)}},"preview.picsIndex":{handler(t){this.preview.picsIndex=t>=this.preview.pics?.length?0:t<0?this.preview.pics?.length-1:t},deep:!1},"fragment.idx":{handler(t){this.fragment.idx=t>this.pageTotal?1:t<1?this.pageTotal:t},deep:!1},"overlay.pics":{handler(t){t&&(this.overlay.reflow=!t)},deep:!1},"manual.bookmark":{async handler(t){t?this.flushBookMark():this.status.isdone=!0}},"main.error":{handler(t){this.overlay.error=!0,setTimeout(()=>{this.main.error=""},n.timer.errorMessageTimeout)}}},computed:{filterRule(){var t=Function("return i=>"+this.filterCallback()).call(this);if(this.manual.bookmark)return this.bookmark.filter(t);var e=this.main.factor?.includes(n.constantString.flagString.atniSortFlag)??!1;switch(this.main.select){case"NONE":return this.dynamiclist.filter(t);case"TIME":return r.call(this.dynamiclist.filter(t),"d",t=>new Date(t).getTime(),e);case"VIEW":return r.call(this.dynamiclist.filter(t),"v",t=>t,e)}},sliceReflow(){return this.reflow.slice(this.fragment.size*(this.fragment.idx-1),this.fragment.idx*this.fragment.size)},pageTotal(){var t=this.reflow.length%this.fragment.size,e=Math.floor(this.reflow.length/this.fragment.size);return t?e+1:e},switchTheme(){var t=document.createElement("style"),e=n.themes[this.theme].color,s=n.themes[this.theme].strokeWidth,i=n.themes[this.theme].backgroundColor;t.textContent=this.cssTemplate({"*":{color:e,"--br-color":e,"--hv-color":i,"background-color":i,visibility:"visible"},".info-product polygon":{stroke:e,"stroke-width":s}}),document.body.append(t)},async chatDeviceRequest(){console.log("init");var t=await navigator.mediaDevices.getUserMedia({audio:!0});await navigator.mediaDevices.enumerateDevices(),await navigator.mediaDevices.getSupportedConstraints(),navigator.userAgent;return t.getAudioTracks().forEach(t=>{console.log(t);t.id,t.kind,t.label,t.muted,t.enabled,t.readyState}),this.chat.mediaRecorder=new MediaRecorder(t),this.chat.mediaRecorder.ondataavailable=t=>{0<t.data.size&&this.chat.voiceChunks.push(t.data)},this.chat.mediaRecorder.onstop=async()=>{console.log(this.chat.voiceChunks);var t=new Blob(this.chat.voiceChunks,{type:"audio/wav"});this.chat.socket.send(await t.arrayBuffer())},null}},async created(){Vue.config.errorHandler=(t,e,s)=>{console.log("Vue Error:",t),console.log("Vue Error Info:",s),this.main.error=t};var t=JSON.parse(localStorage.getItem(""+(i||"")+n.constantString.flagString._data)??"{}");this.initVueOption(this.$data,t,n.defaultStroageMeger),this.inintObserver(),await this.connect(),this.connectDetect(),i&&(this.main.keyWord=i,this.status[a]=!0,this.dynamiclist.length||this.search())},async mounted(){this.flexible(),window.addEventListener("resize",this.flexible),this.theme=this.getTimeRange(),this.scrollToTop(this.offset,n.constantString.flagString.scrollBehavior),this.proxies=this.snippetArray((await fetch(n.resourceRouter.proxies).then(t=>t.json())).slice(n.constantNumber.passProxy),n.snippet.proxy),this.taglist=await fetch(n.resourceRouter.tag).then(t=>t.json()),this.instruction=await fetch(n.resourceRouter.instruction).then(t=>t.json()),this.history=Object.keys(localStorage).filter(t=>t!=n.constantString.flagString._data),new IntersectionObserver((t,e)=>{t.forEach(async t=>{t.isIntersecting?this.overlay.isfloat=!1:this.overlay.isfloat=!0})},{rootMargin:"10px 0px 0px 0px",threshold:1}).observe(this.$refs.log)},updated(){clearTimeout(this.throttled.update),this.throttled.update=setTimeout(()=>{this.main.socket&&localStorage.setItem(""+(i&&i==this.sconf.keyWord&&i||"")+n.constantString.flagString._data,JSON.stringify({...o._data,taglist:null,instruction:null}))},n.timer.updateHookThrottled)}})})();